<!DOCTYPE html>
<html>

<head>
    <title>Geocoding service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <!-- Include jQuery -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js">
    </script>
    <!-- Include Google Maps - replace API key below where it says key=... -->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyA0FGRNPcW8iEX65-mULqAQ5btibgEpgs8">
    </script>

    <!-- ensure the output results are separated by newlines - keep formatting intact -->
    <style>
        .none {
            white-space: pre-line
        }
    </style>

    <script>
        var service;

        //initialize the Google Maps library and set the click event for our button
        $(document).ready(() => {
            service = new google.maps.DistanceMatrixService();
            $("#btn").click(processPlaces);
        })

        /*
        Extract origin and destinations from given text. Expected format is:
        origin1
        dest1
        dest2
        dest3

        o2
        d1
        d2
        d5

        o3
        d1
        ...
        */
        function getDistanceMatrixRequests(text) {
            let lines = text.split('\n'); //split input text into an array
            let requests = [];

            let origin = null;
            let destinations = [];
            for (line of lines) {
                //reset the list of destinations if a blank line is reached
                if (line === '') {
                    requests.push({
                        'origins': [origin],
                        'destinations': destinations,
                        travelMode: 'DRIVING',
                    });
                    origin = null;
                    destinations = [];
                } else if (origin) { //if origin is already defined, add this line to the destinations
                    destinations.push(line);
                } else { //origin is not defined, thus this is the origin
                    origin = line;
                }
            }
            //add the final origin/dests if the input did not end with a newline
            if (lines[lines.length - 1] !== '') {
                requests.push({
                    'origins': [origin],
                    'destinations': destinations,
                    travelMode: 'DRIVING'
                });
            }
            return requests;
        }

        function formatResults(origin, results) {
            let str = '';
            for (let i = 0; i < results.destinationAddresses.length; i++) {
                let dest = results.destinationAddresses[i];
                let element = results.rows[0].elements[i]; //only 1 origin used
                let status = element.status;
                let duration = null;
                let dist = null;
                if (status == google.maps.places.PlacesServiceStatus.OK) {
                    duration = element.duration.text;
                    dist = element.distance.text;
                }
                str += [origin, dest, dist, duration].join('--');
                str += '\n';
            }
            return str
        }

        //callback function when the button is clicked
        function processPlaces() {
            let input = $("#places").val(); // get the input text
            const requests = getDistanceMatrixRequests(input);
            let distances = [];

            for (req of requests) {
                distances.push(new Promise((resolve, reject) => { //create a promise for each search - allow it to be asynchronous
                    service.getDistanceMatrix(req, function(results, status) { //results = https://developers.google.com/maps/documentation/javascript/distancematrix#distance_matrix_requests
                        if (status == google.maps.places.PlacesServiceStatus.OK) {
                            console.log('Query "', req, '" returns "', results);
                            let entry = formatResults(req.origins[0], results)
                            resolve(entry);
                        }
                        //something went wrong...
                        else {
                            resolve("SEARCH ERROR = " + status);
                        }
                    });
                }));
            }

            //wait for all of our promises/searches to finish, then print to screen
            Promise.all(distances).then(values => {
                $("#results").text(values.join('\n'));
                console.log('All = ' + values)
            }).catch(reason => {
                //something went wrong
                $("#results").text('Error - check console (F12)');
                console.log(reason)
            });
        }
    </script>
</head>

<body>
    <!-- Setup the HTML DOM elements required in the JS code -->
    <h4>Map Origin to destinations</h4>
    <p>Write your queries in the text box and click the button. </p>
    <p> Extract origin and destinations from given text. Expected format is:</p>
    <p> origin1</p>
    <p>dest1</p>
    <p>dest2</p>
    <p>dest3</p>
    <p>**empty line**</p>
    <p>o2</p>
    <p>d1</p>
    <p>d2</p>
    <p>**empty line**</p>
    <p> ...</p>
    <p>Results are shown below as [origin--dest--dist--duration] and full result data is available in the console.</p>
    Places: <textarea type="text" id="places" name="places" cols="40" rows="5"></textarea>
    <button id="btn" type="button">Click Me!</button>

    <h2>Results</h2>
    <div id="results" class='none'> </div>

    <div id="map"></div>

</body>

</html>
